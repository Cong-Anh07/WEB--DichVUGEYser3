<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Sử Đặt Lịch - Nanogeyser</title>
    <link rel="icon" href="./assets/logo-web-CIp09qxk.png" type="image/png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script type="module" crossorigin src="./assets/config-CAO_t3db.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/styles-DXe8NeaQ.css">
</head>

<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <a href="index.html"><img src="./assets/logo-BPhqW2iW.png" alt="Nanogeyser Logo"></a>
                </div>
                <ul class="nav-menu">
                    <li><a href="index.html">Trang Chủ</a></li>
                    <li><a href="booking.html">Đặt Lịch</a></li>
                    <li><a href="index.html#warranty">Bảo Hành</a></li>
                    <li><a href="index.html#contact">Liên Hệ</a></li>
                    <li id="authNav"><a href="login.html" class="btn-secondary">Đăng Nhập</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="history-main">
        <div class="container">
            <div class="page-header">
                <h1><i class="fas fa-calendar-check"></i> Lịch Sử Đặt Lịch</h1>
                <p>Xem lại các lịch hẹn bảo dưỡng, sửa chữa của bạn</p>
            </div>

            <div class="history-tabs">
                <a href="history-booking.html" class="tab active">Lịch sử đặt lịch</a>
                <a href="history-filter.html" class="tab">Nhật ký thay lõi</a>
            </div>

            <div class="filter-toolbar">
                <label for="statusFilter"><i class="fas fa-filter"></i> Lọc theo trạng thái:</label>
                <select id="statusFilter" class="status-filter" onchange="filterByStatus()">
                    <option value="all">Tất cả</option>
                    <option value="1">Chờ xác nhận</option>
                    <option value="2">Đã xác nhận</option>
                    <option value="3">Hoàn thành</option>
                </select>
            </div>

            <div id="historyLoading" class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Đang tải lịch sử...</p>
            </div>

            <div id="historyList" class="history-list" style="display:none;"></div>
            <div id="emptyState" class="empty-state" style="display:none;">
                <i class="fas fa-calendar-times"></i>
                <h3>Chưa có lịch hẹn nào</h3>
                <p>Bạn chưa đặt lịch hẹn nào. Hãy đặt lịch ngay!</p>
                <a href="booking.html" class="btn btn-primary">Đặt Lịch Ngay</a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Nanogeyser. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <script>
        let allHistory = []; // Lưu tất cả lịch sử để filter

        document.addEventListener('DOMContentLoaded', function () {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('Vui lòng đăng nhập để xem lịch sử!');
                window.location.href = './login.html';
                return;
            }
            updateAuthNav();
            loadHistory(currentUser.id);
        });

        function updateAuthNav() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const authNav = document.getElementById('authNav');
            if (currentUser && authNav) {
                authNav.innerHTML = `
                <div class="user-dropdown">
                    <a href="#" class="user-btn">
                        <i class="fas fa-user-circle"></i>
                        <span>${ currentUser.username || currentUser.phone }</span>
                        <i class="fas fa-chevron-down"></i>
                    </a>
                    <div class="dropdown-menu">
                        <a href="booking.html"><i class="fas fa-calendar-plus"></i> Đặt lịch</a>
                        <a href="history-booking.html"><i class="fas fa-calendar-check"></i> Lịch sử đặt lịch</a>
                        <a href="history-filter.html"><i class="fas fa-filter"></i> Nhật ký thay lõi</a>
                        <a href="#" onclick="logout(); return false;"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
                    </div>
                </div>
            `;
            }
        }

        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                sessionStorage.clear();
                window.location.href = './index.html';
            }
        }

        function loadHistory(userId) {
            fetch(`/api/tasks/customer/${ userId }`)
                .then(res => res.json())
                .then(result => {
                    document.getElementById('historyLoading').style.display = 'none';
                    console.log('Tasks by customer response:', result);

                    let tasks = [];
                    if (result.data && Array.isArray(result.data)) {
                        tasks = result.data;
                    } else if (Array.isArray(result)) {
                        tasks = result;
                    }

                    allHistory = tasks; // Lưu lại để filter

                    if (tasks.length > 0) {
                        displayHistory(tasks);
                    } else {
                        document.getElementById('emptyState').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.log('Error:', err);
                    document.getElementById('historyLoading').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                });
        }

        function filterByStatus() {
            const status = document.getElementById('statusFilter').value;

            if (status === 'all') {
                displayHistory(allHistory);
            } else {
                const filtered = allHistory.filter(item => item.status === status);
                if (filtered.length > 0) {
                    displayHistory(filtered);
                } else {
                    document.getElementById('historyList').innerHTML = `
                    <div class="empty-filter-result">
                        <i class="fas fa-search"></i>
                        <p>Không có lịch hẹn với trạng thái "${ getStatusText(status) }"</p>
                    </div>
                `;
                    document.getElementById('historyList').style.display = 'block';
                }
            }
        }

        function displayHistory(history) {
            const container = document.getElementById('historyList');
            container.style.display = 'block';
            container.innerHTML = history.map(item => {
                const customer = item.customer || {};
                const product = item.product_info || {};

                // Format ngày từ time_star hoặc created_at
                let displayDate = 'N/A';
                if (item.time_star) {
                    displayDate = formatDate(item.time_star);
                } else if (item.created_at) {
                    displayDate = formatDate(item.created_at);
                }

                return `
            <div class="history-card" onclick="window.location.href='booking-detail.html?id=${ item.id }'" style="cursor:pointer;">
                <div class="history-header">
                    <span class="history-date"><i class="fas fa-calendar"></i> ${ displayDate }</span>
                    <span class="history-status status-${ getStatusClass(item.status) }">${ getStatusText(item.status) }</span>
                </div>
                <div class="history-body">
                    <h3>${ item.name || 'Dịch vụ bảo dưỡng' }</h3>
                    <p><i class="fas fa-user"></i> ${ customer.username || customer.name || 'Khách hàng' }</p>
                    <p><i class="fas fa-phone"></i> ${ customer.phone || item.phone || '' }</p>
                    <p><i class="fas fa-map-marker-alt"></i> ${ customer.address || item.address || '' }</p>
                    ${ product.order_id ? `<p><i class="fas fa-box"></i> Đơn hàng #${ product.order_id }</p>` : '' }
                    ${ item.des ? `<p><i class="fas fa-sticky-note"></i> ${ item.des }</p>` : '' }
                </div>
                <div class="history-footer">
                    <span class="view-detail"><i class="fas fa-eye"></i> Xem chi tiết</span>
                </div>
            </div>
            `;
            }).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === '0000-00-00 00:00:00') return 'N/A';
            try {
                // Format: "2025-07-03 14:00:00" -> "03/07/2025 14:00"
                const parts = dateStr.split(' ');
                const datePart = parts[0].split('-');
                const timePart = parts[1] ? parts[1].substring(0, 5) : '';

                if (datePart.length === 3) {
                    return `${ datePart[2] }/${ datePart[1] }/${ datePart[0] }${ timePart ? ' ' + timePart : '' }`;
                }
                return dateStr;
            } catch (e) {
                return dateStr;
            }
        }

        function getStatusClass(status) {
            const map = { '1': 'pending', '2': 'confirmed', '3': 'completed', '4': 'cancelled' };
            return map[status] || 'pending';
        }

        function getStatusText(status) {
            const map = { '1': 'Chờ xác nhận', '2': 'Đã xác nhận', '3': 'Hoàn thành', '4': 'Đã hủy' };
            return map[status] || 'Chờ xử lý';
        }
    </script>

    <style>
        .history-main {
            padding: 100px 0 60px;
            min-height: 70vh;
            background: #f8f9fa;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 2rem;
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        .page-header h1 i {
            color: #28a745;
            margin-right: 10px;
        }

        .page-header p {
            color: #666;
        }

        .history-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .history-tabs .tab {
            padding: 12px 24px;
            background: white;
            border-radius: 25px;
            text-decoration: none;
            color: #666;
            font-weight: 500;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
        }

        .history-tabs .tab.active,
        .history-tabs .tab:hover {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        /* Filter toolbar */
        .filter-toolbar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .filter-toolbar label {
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-toolbar label i {
            color: #28a745;
        }

        .status-filter {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 0.95rem;
            cursor: pointer;
            background: white;
            min-width: 180px;
            transition: all 0.3s;
        }

        .status-filter:focus {
            outline: none;
            border-color: #28a745;
        }

        .empty-filter-result {
            text-align: center;
            padding: 50px 20px;
            background: white;
            border-radius: 15px;
            color: #666;
        }

        .empty-filter-result i {
            font-size: 2.5rem;
            color: #ccc;
            margin-bottom: 15px;
            display: block;
        }

        .loading-state,
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-state i,
        .empty-state i {
            font-size: 3rem;
            color: #28a745;
            margin-bottom: 20px;
        }

        .empty-state i {
            color: #ccc;
        }

        .empty-state h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #666;
            margin-bottom: 20px;
        }

        .history-list {
            display: grid;
            gap: 20px;
        }

        .history-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .history-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-date {
            color: #666;
            font-size: 0.9rem;
        }

        .history-date i {
            margin-right: 5px;
            color: #28a745;
        }

        .history-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .history-body h3 {
            color: #1a1a2e;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .history-body p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .history-body p i {
            width: 20px;
            color: #28a745;
        }

        .history-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
            text-align: right;
        }

        .view-detail {
            color: #28a745;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .view-detail i {
            margin-right: 5px;
        }

        /* Dropdown styles */
        .user-dropdown {
            position: relative;
        }

        .user-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #28a745, #34ce57);
            color: white !important;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            z-index: 9999;
            margin-top: 5px;
            padding: 8px 0;
        }

        .user-dropdown:hover .dropdown-menu {
            display: block;
        }

        .dropdown-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: #333 !important;
            text-decoration: none;
        }

        .dropdown-menu a:hover {
            background: #f5f5f5;
            color: #28a745 !important;
        }

        .dropdown-menu a i {
            width: 20px;
            color: #28a745;
        }

        .dropdown-submenu {
            position: relative;
        }

        .submenu-toggle {
            justify-content: space-between;
        }

        .submenu-arrow {
            font-size: 0.7rem;
        }

        .submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            padding: 8px 0;
            margin-left: 5px;
        }

        .dropdown-submenu:hover .submenu {
            display: block;
        }
    </style>
</body>

</html>